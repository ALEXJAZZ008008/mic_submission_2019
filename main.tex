\documentclass{IEEEtran}

\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=1100,stretch=10,shrink=10]{microtype}
\linespread{0.92}

\usepackage{amsmath}
\usepackage{bm}
\usepackage{amssymb}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{stfloats}

\ifCLASSINFOpdf
   \usepackage[pdftex]{graphicx}
\else
   \usepackage[dvips]{graphicx}
\fi

\ifCLASSOPTIONcompsoc
  \usepackage[caption=false,font=normalsize,labelfont=sf,textfont=sf]{subfig}
\else
  \usepackage[caption=false,font=footnotesize]{subfig}
\fi

\usepackage[style=ieee,maxbibnames=1,minbibnames=1,maxcitenames=1,mincitenames=1,backend=biber,defernumbers=false]{biblatex}
\addbibresource{./bibtex/bib/Biblio.bib}

\begin{document}
\title{Impact of Time-of-Flight on Respiratory Motion Modelling using Non-Attenuation-Corrected PET}
\author{Alexander~C.~Whitehead~(\IEEEmembership{Student~Member~IEEE}),
        Elise~C.~Emond~(\IEEEmembership{Student~Member~IEEE}),
        Nikos~Efthimiou~(\IEEEmembership{Member~IEEE}),
        Adeyemi~Akintonde~(\IEEEmembership{Student~Member~IEEE}),
        Brian~F.~Hutton~(\IEEEmembership{Senior~Member~IEEE}),
        Jamie~McClelland
        and~Kris~Thielemans~(\IEEEmembership{Senior~Member~IEEE})%

    \thanks{This work was supported by GE Healthcare.}%
    \thanks{Elise~C.~Emond was supported by GlaxoSmithKline (BIDS3000030921)}
    \thanks{Alexander~C.~Whitehead, Elise~C.~Emond, Brian~F.~Hutton and Kris~Thielemans are with the Institute of Nuclear Medicine, University College London, London, NW1~2BU, UK (contact: \texttt{alexander.whitehead.18@ucl.ac.uk}.}%
    \thanks{Nikos Efthimiou is with the PET Research Centre, Faculty of Health Sciences, University of Hull, Hull, HU6~7RX, UK}%
    \thanks{Adeyemi~Akintonde and Jamie~McClelland are with the Centre for Medical Image Computing, University College London, London, NW1~2BU, UK.}%
}

\maketitle
\vspace{-1cm}

\IEEEpeerreviewmaketitle
\begin{abstract}
Respiratory motion reduces image quality in PET. Unless gated CT or MR data are available, motion correction relies on registration of the PET data. To avoid mis-registration due to attenuation mismatches, most existing methods rely on pair-wise registration of Non-Attenuation-Corrected (NAC) PET volumes. This is a challenging problem due to the low contrast and high noise of these volumes. This paper investigates the possibility of using motion models for respiratory motion correction in PET, and in particular whether incorporating Time-of-Flight (TOF) information increases the accuracy of the motion models derived from the NAC reconstructed images. XCAT phantom simulations are used for one bed position with a field of view including the base of the lungs and the diaphragm. A TOF resolution of 375ps is used. NAC images are reconstructed using OSEM and used as input for motion model estimation. Different motion models are compared using the original XCAT input volumes. The results indicate that TOF improves the accuracy of the motion model considerably.

\end{abstract}

\section{Introduction}
\IEEEPARstart{R}{espiratory} motion causes artefacts and loss of resolution in the thoracic region in PET~\cite{Nehmeh2008}. Many methods have been proposed to correct for respiratory motion, usually involving registration between a reference volume and a set of volumes in different positions in the respiratory cycle obtained by gating~\cite{Oliveira2014}. However, such pair-wise registration is sensitive to noise. It also does not allow prediction of the respiratory state for data not used to estimate the motion, for instance to be used for real time motion correction in radiotherapy.

Surrogate driven motion models attempt to overcome these deficiencies by relating the motion in the data to a surrogate signal~\cite{McClelland2013}. The model outputs a transformation or deformation field for every value of the surrogate signal. Motion models are calculated on a series of either time or gating based volumes.

The benefits of using attenuation correction for PET image registration are unclear. If images are reconstructed using a static attenuation map ($\mu$-map), then artefacts caused by the misalignment between the activity distribution and the $\mu$-map would hamper image registration~\cite{Bousse2016a}. It could therefore be advantageous to estimate motion on Non-Attenuation Corrected (NAC) images. However, contrast may be too low to calculate an accurate motion model and artefacts associated with the mismatch between the acquisition and system model could also obscure the underlying motion. 

In the absence of Time-of-Flight (TOF), there is no information on the activity position along the Line-of-Response (LOR), therefore, NAC reconstruction will place the activity towards the surface of the body and along low-density LORs. In TOF, the time information constrains the activity position along the LOR changing the nature and extent of the artefacts associated with NAC. The volumes are different in their expectation not just their noise properties.

The aim of this work is to investigate whether TOF can adequately increase the contrast and accuracy of expectation and lower the noise of NAC images to facilitate the calculation of accurate motion models.

\section{Methods}
XCAT~\cite{Segars2010} was used to generate $6$ volumes over a linear $5$ second breathing cycle, with $1$ volume at full expiration at the beginning of the cycle and $1$ volume at full expiration at the end of the cycle. Activity concentrations were derived from a static FDG patient scan. The breathing surrogate signal $\bm{s}$ was the default displacement of the chest in the Anterior-Posterior (AP) direction and the displacement of the diaphragm in the Inferior-Superior (IS) direction acquired from XCAT. The field of view included the base of the lungs, diaphragm and the top of the liver with a $40$mm diameter spherical lesion placed in the right lung.

PET acquisitions were simulated using STIR~\cite{Thielemans2012} through SIRF~\cite{Ovtchinnikov2017} to forward project the input data to sinograms using the geometry of a GE Discovery 710 and, where relevant, a TOF resolution of $375$ps similar to the GE Signa (using TOF mashing to reduce computation time resulting in $13$ TOF time bins of size $376.5$ps)~\cite{Efthimiou2018}. Attenuation was included in the simulation using the relevant $\mu$-map generated by XCAT. Scatter and randoms were not taken into account in the simulation. Multiple noise realisations were generated to simulate an acquisition as if it had been gated into $6$ bins over an acquisition of $120$s, this emulated a standard single bed position acquisition. Data were reconstructed without attenuation correction using OSEM with $9$ full iterations and $18$ subsets~\cite{Hudson1994}. 

3D B-splines were used to model spatial deformations with the corresponding warping operation denoted as $W(\alpha_t)$. Following~\cite{McClelland2013}, here a motion model where the coefficients of the deformation field at time $t$ are expressed as a polynomial of the scalar $s_t$ or a direct correspondence model.

\begin{equation}
    \alpha_{kt} = R_1 {s_t}^2 + R_2 s_t + R_3
\end{equation}

\noindent Where $\alpha_{kt}$ is the 3D B-spline coefficient for node $k$ at time point $t$, $s_t$ is the surrogate signal at $t$ and $R_1$, $R_2$ and $R_3$ are polynomial coefficients used. 

NiftyRegResp was used to estimate the Respiratory-Correspondence-Model (RCM) of the motion models, using sum of squared differences as an objective function. The surrogate signal passed to NiftyRegResp consisted of both the displacement of the AP and the  diaphragm movement from XCAT.

\section{Results}
\begin{figure*}
    \centering
    \includegraphics[width=0.8\linewidth]{figures/output.png}
    \caption{All volumes correspond to end-inhalation. The first row from left to right: XCAT data, NAC nonTOF reconstructed data and NAC TOF reconstructed data. The second row from left to right: XCAT based RCM applied to mean position XCAT data, NAC nonTOF based RCM applied to mean position XCAT data and NAC TOF based RCM applied to mean position XCAT data. Colour map ranges are consistent for all images on this row. The third row from left to right: The difference between the volumes estimated from the XCAT based RCM and the XCAT data, the difference between the volumes estimated from the NAC nonTOF based RCM and the XCAT data and the difference between the volumes estimated from the NAC TOF based RCM and the XCAT data. Colour map ranges are consistent for all images on this row.}
    \label{fig:output}
\end{figure*}

\begin{table}
    \centering
    \small
        \caption{Comparison of the MSE between the ground truth data and the volumes estimated from the XCAT based RCM, the volumes estimated from the NAC nonTOF based RCM and the volumes estimated from the NAC TOF based RCM.}
    \begin{tabular}{||c|ccc||}
    \hline
        \textbf{MSE}    & \textbf{XCAT} & \textbf{nonTOF}   & \textbf{TOF}  \\
    \hline
        \textbf{$1$}    & $24707$       & $20020$           & $31370$       \\
        \textbf{$2$}    & $28595$       & $39309$           & $30445$       \\
        \textbf{$3$}    & $24242$       & $75570$           & $35417$       \\
        \textbf{$4$}    & $26127$       & $59310$           & $32519$       \\
        \textbf{$5$}    & $26459$       & $12951$           & $26120$       \\
        \textbf{$6$}    & $24707$       & $20020$           & $31370$       \\
    \hline
        \textbf{Mean}   & $26026$       & $41432$           & $31174$       \\
    \hline
        \textbf{SD}     & $1531$        & $23470$           & $3031$        \\
    \hline
    \end{tabular}
    \label{tab:mse}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{figures/com_graph.png}
    \caption{The path of the COM of the lesion on the horizontal axis in the AP direction and on the vertical axis in the IS direction over the $6$ gates for ground truth data, the estimated data from the XCAT based RCM, the estimated data from the NAC nonTOF based RCM and the estimated data from the NAC TOF based RCM.}
    \label{fig:com_graph}
\end{figure}

In order to evaluate the motion models, the $3$ estimated RCM, calculated from the PET XCAT volumes, nonTOF NAC reconstruction and TOF NAC reconstructions, were used to warp the same PET volume, generated by XCAT at the mean breathing position, to estimate the original ground truth $6$ input XCAT volumes. These estimated volumes were compared to the original XCAT input volumes, first, visually by observing the difference between the original XCAT volume and estimated volume at the same gate. The reconstructed data, estimated volumes and difference can be seen in Fig~\ref{fig:output}.

The estimated and original $\bold{f}_t$ volumes were also compared using Mean-Squared-Errors (MSE) as $\mathrm{mean}((\bold{f}_t-W(\alpha_t) \bold{f}_\mathrm{ref})^2)$. This can be seen in Table~\ref{tab:mse}. The mean MSE was found to be lower for the NAC TOF data than for the NC nonTOF, the standard deviation (SD) was also lower.

The centre of mass (COM) of the lesion was also tracked, over the $6$ gates, by estimating the $6$ volumes as above but only including the lesion in the estimation. This can be seen in Fig~\ref{fig:com_graph}. The path of the NAC TOF data visually appear to more closely follow the ground truth path than the NAC nonTOF data, the data points for the NAC TOF data also appear to be visually closer than the NAC nonTOF

\section{Discussion and Conclusions}
NAC TOF motion models were found to be more robust than NAC nonTOF motion models, both visually and when comparing MSE, SD and COM. This was most noticeable for the lung lesion in the thoracic cavity. This is likely due to the improved image contrast and more accurate expectation of NAC TOF images.

In the future, research will focus on investigating the robustness of the motion model estimation to different noise levels, acquisition duration and size of lesion.

\AtNextBibliography{\small}
\printbibliography

\end{document}
